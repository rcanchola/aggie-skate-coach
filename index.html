<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reveille's Aggie Skate Coach</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap');
        
        /* Official Aggie Maroon and Gray */
        :root {
            --maroon: #500000; 
            --silver: #AAAAAA;
        }

        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f5f5f5; /* Light Gray Background */
        }
        
        .card { 
            background-color: #FFFFFF; 
            border: 4px solid var(--maroon); /* Bold Maroon Border */
            box-shadow: 0 15px 25px rgba(80, 0, 0, 0.4); 
            transition: transform 0.3s ease;
        }
        .card:hover {
            transform: translateY(-2px);
        }
        
        .advice-box { 
            text-align: left; 
            font-size: 0.95rem;
            padding-left: 1rem;
        }
        /* --- CSS FIX: Adding spacing to rendered Markdown elements --- */
        .advice-box p {
            margin-bottom: 0.75rem; /* Space between paragraphs */
        }
        .advice-box h2 {
            font-size: 1.15rem; /* Style for markdown header 2 */
            font-weight: bold;
            margin-top: 1rem;
            margin-bottom: 0.5rem;
        }
        .advice-box ul {
            list-style: disc;
            margin-left: 1.5rem;
            padding-left: 0;
            margin-bottom: 0.75rem; /* Space after the list */
        }
    </style>
</head>
<body class="p-4 md:p-8 flex items-center justify-center min-h-screen">

    <!-- Global Variables for Firebase/API (Mandatory in this environment) -->
    <script>
        // Variables defined globally for subsequent script access.
        __app_id = typeof __app_id !== 'undefined' ? __app_id : 'skating-aggie-coach';
        apiKey = "AIzaSyBq84-dCLwAYjN_9scGTpYED6FcQLT3DWg"; // API Key is automatically supplied if left empty
        apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
    </script>
    
    <div class="card w-full max-w-xl p-6 rounded-xl space-y-6">
        <h1 class="text-4xl font-black text-center text-[#500000] flex items-center justify-center gap-4">
            <!-- Aggie Star Icon (Symbolic of the A&M spirit and Reveille's rank) -->
            <svg xmlns="http://www.w3.org/2000/svg" width="36" height="36" viewBox="0 0 24 24" fill="currentColor" class="text-[#500000]">
                <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14l-5-4.87 6.91-1.01L12 2z"/>
            </svg>
            Reveille's Skate School
            <span class="text-xl text-[#AAAAAA] font-bold">WHOOP!</span>
        </h1>
        <p class="text-center text-gray-600 font-semibold border-b pb-4 border-[#500000]/20">
            Let the First Lady of Aggieland critique your form! Gig 'Em!
        </p>

        <div class="space-y-4 text-gray-700">
            <label for="videoFile" class="block text-sm font-extrabold text-[#500000] uppercase tracking-wider">Upload Your Skating Video (Show that 12th Man hustle!)</label>
            <input type="file" id="videoFile" accept="video/mp4,video/quicktime" class="block w-full text-sm text-gray-600 file:mr-4 file:py-3 file:px-6 file:rounded-full file:border-0 file:text-base file:font-bold file:bg-[#500000]/10 file:text-[#500000] hover:file:bg-[#500000]/20 transition duration-150 rounded-lg p-2 border-2 border-dashed border-[#500000]/40 cursor-pointer">
            
            <label for="skatingMove" class="block text-sm font-extrabold text-[#500000] uppercase tracking-wider pt-2">What move are you doing, future Aggie legend?</label>
            <input type="text" id="skatingMove" placeholder="e.g., Kickflip, Ollie, Heel Flip (Must be perfect, just like the Corps!)" class="w-full px-4 py-3 border-2 border-[#500000]/40 rounded-lg focus:ring-4 focus:ring-[#500000]/50 focus:border-[#500000]" value="Kickflip">

            <button id="analyzeBtn" class="w-full bg-[#500000] text-white py-4 rounded-xl font-black uppercase text-lg tracking-widest shadow-xl hover:bg-[#400000] transition duration-200 focus:outline-none focus:ring-4 focus:ring-[#500000] focus:ring-opacity-70 disabled:bg-[#500000]/50">
                A-RUFF! START ANALYSIS
            </button>
        </div>

        <!-- Analysis Output Section -->
        <div id="outputSection" class="pt-6 border-t border-[#500000]/30 hidden">
            <h2 class="text-xl font-extrabold text-[#500000] mb-3 border-b border-[#500000]/20 pb-2">Reveille's Official Critique</h2>
            <div id="analysisOutput" class="advice-box p-4 bg-gray-50 rounded-lg text-gray-800 border-2 border-[#AAAAAA] min-h-[150px] shadow-inner">
                <!-- Analysis results will appear here -->
            </div>
            <div id="loadingIndicator" class="text-[#500000] font-bold mt-4 text-center hidden">
                <div class="animate-spin inline-block w-8 h-8 border-4 border-[#500000] border-t-transparent rounded-full mr-2"></div>
                Reveille is watching... Analyzing the footage like a Corps Inspection. Stand by for the score!
            </div>
        </div>

        <!-- Error/Message Box -->
        <div id="messageBox" class="p-3 mt-4 bg-red-100 border border-red-400 text-red-700 rounded-lg hidden" role="alert"></div>
    </div>

    <script>
        const videoFileEl = document.getElementById('videoFile');
        const skatingMoveEl = document.getElementById('skatingMove');
        const analyzeBtn = document.getElementById('analyzeBtn');
        const analysisOutput = document.getElementById('analysisOutput');
        const outputSection = document.getElementById('outputSection');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const messageBox = document.getElementById('messageBox');

        /**
         * Clears and displays a message in the dedicated message box.
         */
        function showMessage(message, type = 'error') {
            messageBox.textContent = message;
            messageBox.className = `p-3 mt-4 rounded-lg font-medium ${type === 'error' ? 'bg-red-100 border border-red-400 text-red-700' : 'bg-green-100 border border-green-400 text-green-700'}`;
            messageBox.classList.remove('hidden');
        }

        /**
         * Converts a File object to a GenerativePart object for the API payload.
         */
        async function fileToGenerativePart(file) {
            const base64Data = await new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });

            return {
                inlineData: {
                    data: base64Data,
                    mimeType: file.type,
                },
            };
        }

        /**
         * Executes the API call to Gemini with exponential backoff.
         */
        async function fetchWithBackoff(payload, retries = 3) {
            try {
                // apiUrl is globally accessible
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`API Error: ${errorData.error?.message || response.statusText}`);
                }
                
                return await response.json();
            } catch (error) {
                if (retries > 0) {
                    const delay = Math.pow(2, 3 - retries) * 1000;
                    console.warn(`Retrying in ${delay}ms...`, error.message);
                    await new Promise(resolve => setTimeout(resolve, delay));
                    return fetchWithBackoff(payload, retries - 1);
                }
                throw error;
            }
        }


        async function handleAnalysis() {
            messageBox.classList.add('hidden');
            analysisOutput.textContent = '';
            outputSection.classList.remove('hidden');
            loadingIndicator.classList.remove('hidden');
            analyzeBtn.disabled = true;

            const file = videoFileEl.files[0];
            const moveName = skatingMoveEl.value.trim();

            if (!file) {
                showMessage('A-Ruff! Please show Reveille a video! We need to see the action.');
                loadingIndicator.classList.add('hidden');
                analyzeBtn.disabled = false;
                return;
            }
            
            if (file.size > 20 * 1024 * 1024) {
                 showMessage('That file is bigger than the Aggie bonfire! We can only handle clips under 20MB for immediate analysis. Try a shorter one!');
                 loadingIndicator.classList.add('hidden');
                 analyzeBtn.disabled = false;
                 return;
            }

            if (!moveName) {
                showMessage('Good Dog! You missed a step. Tell Reveille what trick you\'re trying to land.');
                loadingIndicator.classList.add('hidden');
                analyzeBtn.disabled = false;
                return;
            }

            try {
                // 1. Convert video file to a Part object
                const videoPart = await fileToGenerativePart(file);

                // 2. Define the Reveille-themed system instruction (The AI's persona)
                const systemPrompt = `You are **Reveille**, the official mascot and First Lady of Aggieland. You are a highly focused, encouraging, and spirited skateboarding coach. Analyze the user's video of a ${moveName}. 
                Provide **three to four extremely concise, actionable points** of advice for immediate improvement. Your response **MUST** start with a short, encouraging introductory paragraph (1-2 sentences). 
                The advice **MUST** be formatted using a **clear Markdown bulleted list** and **MUST use bolding** on key terms, tricks, and Aggie references to maximize visual appeal and readability. 
                Crucially, at the very end of your advice, you **MUST** include the two high-quality YouTube links (URLs) under a **Markdown H2 heading (## Film Study - Whoop!)** to clearly separate the links from the critique.
                Your feedback MUST be highly personalized with dog-themed and Texas A&M cultural references (e.g., barks, "Good Dog!", "Corps of Cadets," "Gig 'em," "whoop"). 
                Start your response with "A-Ruff! Howdy, Aggie Skater! Here is Reveille's quick critique on your ${moveName}:"`;
                
                const userQuery = `Analyze this video of me attempting a ${moveName}. Give me specific improvement advice on stance, timing, and execution, as if you were coaching me at Kyle Field.`;

                // 3. Construct the Multimodal Payload
                const payload = {
                    contents: [
                        { parts: [
                            videoPart, // The video data part
                            { text: userQuery } // The text prompt
                        ] }
                    ],
                    systemInstruction: {
                        parts: [{ text: systemPrompt }]
                    },
                };
                
                // 4. Call the API (using Google Search grounding for YouTube links)
                const result = await fetchWithBackoff({ ...payload, tools: [{ "google_search": {} }] });

                // 5. Extract and display the result
                const generatedText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                
                if (generatedText) {
                    // Use innerHTML to render Markdown formatting (bold, lists, headers, links)
                    analysisOutput.innerHTML = generatedText;
                } else {
                    showMessage("Analysis failed to return text. Even Reveille can't make sense of that! Try a different video or prompt. Good Dog!");
                }

            } catch (error) {
                console.error('API or File Error:', error);
                showMessage(`An error occurred: ${error.message}. Check the console for details. Don't worry, even the 12th Man sometimes needs a retry!`);
            } finally {
                loadingIndicator.classList.add('hidden');
                analyzeBtn.disabled = false;
            }
        }

        analyzeBtn.addEventListener('click', handleAnalysis);

        // Set up the file input change listener to hide the error message on new file selection
        videoFileEl.addEventListener('change', () => {
            messageBox.classList.add('hidden');
        });

    </script>
</body>
</html>
