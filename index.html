<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reveille's Aggie Skate Coach</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap');
        
        /* Official Aggie Maroon and Gray */
        :root {
            --maroon: #500000; 
            --silver: #AAAAAA;
        }

        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f5f5f5; /* Light Gray Background */
        }
        
        .card { 
            background-color: #FFFFFF; 
            border: 4px solid var(--maroon); /* Bold Maroon Border */
            box-shadow: 0 15px 25px rgba(80, 0, 0, 0.4); 
            transition: transform 0.3s ease;
        }
        .card:hover {
            transform: translateY(-2px);
        }
        
        .advice-box { 
            text-align: left; 
            font-size: 0.95rem;
            padding-left: 1rem;
        }
        /* --- CSS FIX: Adding spacing to rendered Markdown elements --- */
        .advice-box p {
            margin-bottom: 0.75rem; /* Space between paragraphs */
        }
        .advice-box h2 {
            font-size: 1.15rem; /* Style for markdown header 2 */
            font-weight: bold;
            margin-top: 1rem;
            margin-bottom: 0.5rem;
        }
        .advice-box ul {
            list-style: disc;
            margin-left: 1.5rem;
            padding-left: 0;
            margin-bottom: 0.75rem; /* Space after the list */
        }
    </style>
</head>
<body class="p-4 md:p-8 flex items-center justify-center min-h-screen">

    <!-- Global Variables for Firebase/API (Mandatory in this environment) -->
    <script>
        // Variables defined globally for subsequent script access.
        __app_id = typeof __app_id !== 'undefined' ? __app_id : 'skating-aggie-coach';
        // IMPORTANT: Ensure your actual API key is inserted here if deploying publicly!
        const apiKey = "AIzaSyAqjc5HsMnGu7vv_6kkXLeuHyZu2CmOx-0"; // Replace with your key!
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

        const videoFileEl = document.getElementById('videoFile');
        const skatingMoveEl = document.getElementById('skatingMove');
        const analyzeBtn = document.getElementById('analyzeBtn');
        const analysisOutput = document.getElementById('analysisOutput');
        const outputSection = document.getElementById('outputSection');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const messageBox = document.getElementById('messageBox');

        /**
         * Helper function to convert raw text with newlines (\n) 
         * into browser-friendly HTML line breaks (<br>).
         */
        function formatTextForDisplay(text) {
            // Replace all newline characters with <br> tags for visual formatting.
            if (text) {
                return text.replace(/\n/g, '<br>');
            }
            return '';
        }

        /**
         * Clears and displays a message in the dedicated message box.
         */
        function showMessage(message, type = 'error') {
            messageBox.textContent = message;
            messageBox.className = `p-3 mt-4 rounded-lg font-medium ${type === 'error' ? 'bg-red-100 border border-red-400 text-red-700' : 'bg-green-100 border border-green-400 text-green-700'}`;
            messageBox.classList.remove('hidden');
        }

        /**
         * Converts a File object to a GenerativePart object for the API payload.
         */
        async function fileToGenerativePart(file) {
            const base64Data = await new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });

            return {
                inlineData: {
                    data: base64Data,
                    mimeType: file.type,
                },
            };
        }

        /**
         * Executes the API call to Gemini with exponential backoff.
         */
        async function fetchWithBackoff(payload, retries = 3) {
            try {
                // apiUrl is globally accessible
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`API Error: ${errorData.error?.message || response.statusText}`);
                }
                
                return await response.json();
            } catch (error) {
                if (retries > 0) {
                    const delay = Math.pow(2, 3 - retries) * 1000;
                    console.warn(`Retrying in ${delay}ms...`, error.message);
                    await new Promise(resolve => setTimeout(resolve, delay));
                    return fetchWithBackoff(payload, retries - 1);
                }
                throw error;
            }
        }


        async function handleAnalysis() {
            // Reset state
            messageBox.classList.add('hidden');
            analysisOutput.textContent = '';
            outputSection.classList.remove('hidden');
            loadingIndicator.classList.remove('hidden');
            analyzeBtn.disabled = true;

            const file = videoFileEl.files[0];
            const moveName = skatingMoveEl.value.trim();

            if (!file) {
                showMessage('A-Ruff! Please show Reveille a video! We need to see the action.');
                loadingIndicator.classList.add('hidden');
                analyzeBtn.disabled = false;
                return;
            }
            
            if (file.size > 20 * 1024 * 1024) {
                 showMessage('That file is bigger than the Aggie bonfire! We can only handle clips under 20MB for immediate analysis. Try a shorter one!');
                 loadingIndicator.classList.add('hidden');
                 analyzeBtn.disabled = false;
                 return;
            }

            if (!moveName) {
                showMessage('Good Dog! You missed a step. Tell Reveille what trick you\'re trying to land.');
                loadingIndicator.classList.add('hidden');
                analyzeBtn.disabled = false;
                return;
            }

            try {
                // 1. Convert video file to a Part object
                const videoPart = await fileToGenerativePart(file);

                // 2. Define the Reveille-themed system instruction (The AI's persona)
                const systemPrompt = `You are **Reveille**, the official mascot and First Lady of Aggieland. You are a highly focused, encouraging, and spirited skateboarding coach. Analyze the user's video of a ${moveName}. 
                Provide **three to four extremely concise, actionable points** of advice for immediate improvement. Your response **MUST** start with a short, encouraging introductory paragraph (1-2 sentences). 
                The advice **MUST** be formatted using a **clear Markdown bulleted list** and **MUST use bolding** on key terms, tricks, and Aggie references to maximize visual appeal and readability. 
                Crucially, at the very end of your advice, you **MUST** include the two high-quality YouTube links (URLs) under a **Markdown H2 heading (## Film Study - Whoop!)** to clearly separate the links from the critique.
                Your feedback MUST be highly personalized with dog-themed and Texas A&M cultural references (e.g., barks, "Good Dog!", "Corps of Cadets," "Gig 'em," "whoop"). 
                Start your response with "A-Ruff! Howdy, Aggie Skater! Here is Reveille's quick critique on your ${moveName}:"`;
                
                const userQuery = `Analyze this video of me attempting a ${moveName}. Give me specific improvement advice on stance, timing, and execution, as if you were coaching me at Kyle Field.`;

                // 3. Construct the Multimodal Payload
                const payload = {
                    contents: [
                        { parts: [
                            videoPart, // The video data part
                            { text: userQuery } // The text prompt
                        ] }
                    ],
                    systemInstruction: {
                        parts: [{ text: systemPrompt }]
                    },
                };
                
                // 4. Call the API (using Google Search grounding for YouTube links)
                const result = await fetchWithBackoff({ ...payload, tools: [{ "google_search": {} }] });

                // 5. Extract and display the result
                const generatedText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                
                if (generatedText) {
                    // Use formatTextForDisplay to convert newlines to <br> tags, 
                    // which is necessary for correct line spacing with innerHTML.
                    const formattedHtml = formatTextForDisplay(generatedText);
                    analysisOutput.innerHTML = formattedHtml;
                } else {
                    showMessage("Analysis failed to return text. Even Reveille can't make sense of that! Try a different video or prompt. Good Dog!");
                }

            } catch (error) {
                console.error('API or File Error:', error);
                showMessage(`An error occurred: ${error.message}. Check the console for details. Don't worry, even the 12th Man sometimes needs a retry!`);
            } finally {
                loadingIndicator.classList.add('hidden');
                analyzeBtn.disabled = false;
            }
        }

        analyzeBtn.addEventListener('click', handleAnalysis);

        // Set up the file input change listener to hide the error message on new file selection
        videoFileEl.addEventListener('change', () => {
            messageBox.classList.add('hidden');
        });

    </script>
</body>
</html>
